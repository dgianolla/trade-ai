services:
  api:
    build: .
    image: ghcr.io/dgianolla/trade-ai:latest
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/analise_imagens
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=false
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - postgres
      - redis
      - minio
    restart: unless-stopped
    deploy:
      labels:
        - "traefik.enable=true"
        # Domínio exato que a Cloudflare manda:
        - "traefik.http.routers.api_trade.rule=Host(`api-trade.mcbot.api.br`)"
        # Porta onde o código do Python responde:
        - "traefik.http.services.api_trade.loadbalancer.server.port=8000"
        # O Nome Exato da Rede Externa onde o Traefik fala (garanta que é esse mesmo)
        - "traefik.docker.network=network_public"
        # Garante que o roteador receba as requisições normais e seguras da Cloudflare
        - "traefik.http.routers.api_trade.entrypoints=websecure"
        - "traefik.http.routers.api_trade.tls=true"
    networks:
      - analise_network
      - network_public

  # Worker especializado para plantas
  worker-plantas:
    build: .
    image: ghcr.io/dgianolla/trade-ai:latest
    command: celery -A app.core.celery_app worker -Q plantas --loglevel=info --concurrency=2 --hostname=worker-plantas@%h
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/analise_imagens
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=false
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - postgres
      - redis
      - minio
    restart: unless-stopped

  # Worker especializado para análise de fotos
  worker-analise:
    build: .
    image: ghcr.io/dgianolla/trade-ai:latest
    command: celery -A app.core.celery_app worker -Q analise_fotos --loglevel=info --concurrency=2 --hostname=worker-analise@%h
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/analise_imagens
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=false
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - postgres
      - redis
      - minio
    restart: unless-stopped

  # Celery Flower (monitoramento de tasks)
  flower:
    build: .
    image: ghcr.io/dgianolla/trade-ai:latest
    command: celery -A app.core.celery_app flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=analise_imagens
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped

volumes:
  postgres_data:
  minio_data:


networks:
  analise_network: # Referencie a rede do seu Traefik aqui. Exemplo:

  network_public:
    external: true
